<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="英语,翻译,技术," />










<meta name="description" content="昨天闲了一天，半夜到四点多才睡着，今天早上逼自己起床去图书馆，整整在图书馆坐了一天。第一次在图书馆待着中午不回宿舍睡午觉。上午学了一点CSS基础之后就一直在做腾讯云云+翻译社的任务，做到头晕脑胀。翻译一篇英语的技术文章难度还是有些大，先不说我英语本来就不是很好，关键的是这期的任务是我从来没接触过的大数据，还得去查各种资">
<meta name="keywords" content="英语,翻译,技术">
<meta property="og:type" content="article">
<meta property="og:title" content="翻译社任务之大数据">
<meta property="og:url" content="http://yoursite.com/2018/05/27/翻译社任务之大数据/index.html">
<meta property="og:site_name" content="游城">
<meta property="og:description" content="昨天闲了一天，半夜到四点多才睡着，今天早上逼自己起床去图书馆，整整在图书馆坐了一天。第一次在图书馆待着中午不回宿舍睡午觉。上午学了一点CSS基础之后就一直在做腾讯云云+翻译社的任务，做到头晕脑胀。翻译一篇英语的技术文章难度还是有些大，先不说我英语本来就不是很好，关键的是这期的任务是我从来没接触过的大数据，还得去查各种资料。不过还好谷歌翻译够给面子，省了不少事。这个礼拜一开始我就一直说要出去骑车，">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/8skulr1p0e.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/mq3otbdkci.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/mhw6uxzrcc.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/0o4zcof87n.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/1t3dx57v4d.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/hx0yg5s0mz.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/23xn2vmpm3.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/3f2vt5lolg.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/xpdqj9h4ad.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/7k9ew7eq0x.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/1ddjaqrdqf.jpeg">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/ox93q540jk.jpeg">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/g9oyfh3t4b.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/8k54sp6bj4.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/udh6pc3k3w.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/x1s2m33fdo.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/h410jrcpq3.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/bt7d5ygmfp.png">
<meta property="og:image" content="https://ask.qcloudimg.com/http-save/10009/3850/qfv05esfca.png">
<meta property="og:updated_time" content="2018-05-27T08:35:38.972Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="翻译社任务之大数据">
<meta name="twitter:description" content="昨天闲了一天，半夜到四点多才睡着，今天早上逼自己起床去图书馆，整整在图书馆坐了一天。第一次在图书馆待着中午不回宿舍睡午觉。上午学了一点CSS基础之后就一直在做腾讯云云+翻译社的任务，做到头晕脑胀。翻译一篇英语的技术文章难度还是有些大，先不说我英语本来就不是很好，关键的是这期的任务是我从来没接触过的大数据，还得去查各种资料。不过还好谷歌翻译够给面子，省了不少事。这个礼拜一开始我就一直说要出去骑车，">
<meta name="twitter:image" content="https://ask.qcloudimg.com/http-save/10009/3850/8skulr1p0e.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/05/27/翻译社任务之大数据/"/>





  <title>翻译社任务之大数据 | 游城</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/sxyuanfeng" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">游城</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">辗转跋涉</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/27/翻译社任务之大数据/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xujiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="游城">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">翻译社任务之大数据</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-27T15:53:06+08:00">
                2018-05-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index">
                    <span itemprop="name">翻译</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<p>昨天闲了一天，半夜到四点多才睡着，今天早上逼自己起床去图书馆，整整在图书馆坐了一天。第一次在图书馆待着中午不回宿舍睡午觉。<br>上午学了一点CSS基础之后就一直在做腾讯云云+翻译社的任务，做到头晕脑胀。翻译一篇英语的技术文章难度还是有些大，先不说我英语本来就不是很好，关键的是这期的任务是我从来没接触过的大数据，还得去查各种资料。不过还好谷歌翻译够给面子，省了不少事。<br>这个礼拜一开始我就一直说要出去骑车，还说要去光谷的一家咖啡书屋看书享受一下生活，结果车是骑了，昨晚和大智一起骑了二十一公里去东湖中央吃了个甜筒，虽然累但是心里舒服啊。再说去光谷看书这档子事，昨个下午本来想去来着，没料到早上十点起床午觉却还是睡到了下午三点，又奈何天公不作美，是个极其娘炮的阴天，于是此事作罢。今天想着做完翻译，写几道六级阅读如果有时间那就一定要去看书，但是这翻译着实是磨人，做完已是下午四点，于是此事再次作罢。<br>下个礼拜再去吧，或者某个阳光明媚的星期四下午也不错。点一杯咖啡配一块提拉米苏，又或者一杯抹茶配一块蛋糕，换换风格找一本不那么性冷淡的书，坐上一整个下午。</p>
<hr>
<p><strong>下面附上我翻译的成果</strong></p>
<h1 id="使用Kafka-SQL-Windowing进行自定义分区和分析"><a href="#使用Kafka-SQL-Windowing进行自定义分区和分析" class="headerlink" title="使用Kafka SQL Windowing进行自定义分区和分析"></a>使用Kafka SQL Windowing进行自定义分区和分析</h1><p>Apache Kafka使用循环技术给多个分区生成消息。自定义分区技术被用在定义好的分区中生成特定类型的消息，并使生成的消息被特定的消费者使用。这种技术使我们能够控制生成的消息。窗口化允许基于时间限制的事件时间驱动分析和数据分组。有三种不同的窗口化方式，分别是是Tumbling，Session和Hopping。</p>
<p>在本文中，我们将通过以下方式讨论如何处理Citi Bike（美国的共享单车）的骑行数据：</p>
<ul>
<li>使用自定义分区技术根据用户种类划分行程数据。</li>
<li>使用Kafka SQL Windowing在数据流中分析行程细节。</li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>安装以下内容：</p>
<ul>
<li>Scala</li>
<li>Java</li>
<li>Kafka</li>
<li>Confluent</li>
<li>KSQL</li>
</ul>
<h2 id="数据描述"><a href="#数据描述" class="headerlink" title="数据描述"></a>数据描述</h2><p>使用Citi Bike在2017年3月的骑行数据集作为源数据。它包含诸如行程持续时间，开始时间，停止时间，站台名称，站台ID，站台纬度和站台经度等基本信息。</p>
<p>示例数据集：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/8skulr1p0e.png" alt=""></p>
<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><ul>
<li>通过根据用户类型（用户或客户）的不同来划分消息，再将Citi Bike的骑行数据传送给两个不同的代理。</li>
<li>使用Kafka SQL Windowing的理念来分析以下详细信息：<ul>
<li>使用Window Tumbling来分析特定时间范围的行程数量。</li>
<li>使用Hopping Window来分析一定前进时间间隔的行程数量。</li>
<li>使用Session Window来分析一定会话间隔的行程数量。</li>
</ul>
</li>
</ul>
<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a><strong>概要</strong></h2><ul>
<li>设置Kafka集群。</li>
<li>使用自定义分区生成和使用行程详细信息。</li>
<li>创建行程数据流。</li>
<li>使用Window Tumbling进行流式分析。</li>
<li>使用Window Session执行流式分析。</li>
<li>使用Window Hopping执行流式分析。</li>
</ul>
<h2 id="设置Kafka集群"><a href="#设置Kafka集群" class="headerlink" title="设置Kafka集群"></a>设置Kafka集群</h2><p>如果要通过更改集群中的代理端口从而在同一台服务器上设置集群，请执行以下步骤：</p>
<ul>
<li>在默认端口2181上运行ZooKeeper。ZooKeeper数据默认存储在/ tmp / data中。</li>
<li>将默认路径（/ tmp / data）更改为具有足够内存空间的其他路径，以便不中断生产和消费。</li>
<li>编辑根目录下etc / kafka / zookeeper.properties中的zookeeper.properties文件中的ZooKeeper配置，如下图所示：</li>
</ul>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/mq3otbdkci.png" alt=""></p>
<ul>
<li>使用以下命令启动ZooKeeper：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zookeeper-server-start etc/kafka/zookeeper.properties</span><br></pre></td></tr></table></figure>
<p>您可以在下面的图片中看到ZooKeeper启动的相关信息：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/mhw6uxzrcc.png" alt=""></p>
<ul>
<li>在端口9092中运行默认的Kafka代理并将代理ID设置为0，以此来启动集群中的第一个代理。默认日志路径是/ tmp / kafka-logs。</li>
<li>编辑默认日志路径（/ tmp / kafka-logs）以启动根目录中的server.properties文件中的第一个代理。<br>输入命令 vi etc / kafka / server.properties（启动vi编辑器来读写文件）</li>
</ul>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/0o4zcof87n.png" alt=""></p>
<ul>
<li>使用以下命令启动代理：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-server-start etc/kafka/server.properties</span><br></pre></td></tr></table></figure>
<p>您可以使用代理ID 0和端口9092查看第一个代理的启动：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/1t3dx57v4d.png" alt=""></p>
<ul>
<li>通过将etc / kafka /下的server.properties复制为server1.properties来启动集群中的第二个代理，以此来配置集群中的第二个代理。</li>
<li>编辑server1.properties文件   输入命令 vi etc / kafka / server1.properties。</li>
</ul>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/hx0yg5s0mz.png" alt=""></p>
<ul>
<li>使用以下命令启动代理：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-server-start etc/kafka/server1.properties</span><br></pre></td></tr></table></figure>
<p>您可以使用代理ID 1和端口9093查看第二个代理启动：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/23xn2vmpm3.png" alt=""></p>
<ul>
<li>使用以下命令列出集群中可用的代理：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zookeeper-shell localhost:2181 ls /brokers/ids</span><br></pre></td></tr></table></figure>
<p>您可以查看集群中可用的代理，如下图所示：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/3f2vt5lolg.png" alt=""></p>
<p>在上述情况下，两个代理在同一个节点上启动。如果代理在不同节点中可用，则可以更快地并行处理消息，并且可以通过在不同节点存储器中共享消息来生成大量消息，这样可以解决内存问题。</p>
<h2 id="使用自定义分区生成和使用行程详细信息"><a href="#使用自定义分区生成和使用行程详细信息" class="headerlink" title="使用自定义分区生成和使用行程详细信息"></a>使用自定义分区生成和使用行程详细信息</h2><p>若要使用自定义分区生成和使用行程详细信息，请执行以下步骤：</p>
<ul>
<li>使用以下命令创建具有两个分区的行程数据的主题：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kafka-topics --create --zookeeper localhost:2181 --topic trip-data --replication-factor 1 --partitions 1</span><br></pre></td></tr></table></figure>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/xpdqj9h4ad.png" alt=""></p>
<ul>
<li>描述该主题以查看创建的分区的负责人。</li>
</ul>
<p>您可以看到代理0负责分区0的消息传输，代理1负责分区1的消息传输，如下图所示</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/7k9ew7eq0x.png" alt=""></p>
<ul>
<li>使用自定义分区技术来生成消息。</li>
<li>通过使用以下命令覆盖分区器接口来创建CustomPartitioner类：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">override def partition(topic: String, key: Any, keyBytes: Array[Byte], value: Any, valueBytes: Array[Byte], cluster: Cluster): Int = &#123;</span><br><span class="line"> var partition = 0</span><br><span class="line"> val keyInt = Integer.parseInt(key.asInstanceOf[String])</span><br><span class="line"> val tripData = value.asInstanceOf[String]</span><br><span class="line"> //从产生的信息中得到用户类型</span><br><span class="line"> val userType = tripData.split(&quot;,&quot;)(12)</span><br><span class="line"> //根据用户类型将分区分配给消息</span><br><span class="line"> if (&quot;Subscriber&quot;.equalsIgnoreCase(userType)) &#123;</span><br><span class="line">  partition = 0;</span><br><span class="line"> &#125; else if (&quot;Customer&quot;.equalsIgnoreCase(userType)) &#123;</span><br><span class="line">  partition = 1;</span><br><span class="line"> &#125;</span><br><span class="line"> println(&quot;Partition for message &quot; + value + &quot; is &quot; + partition)</span><br><span class="line"> partition</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您可以查看生成到分区0中的Subscriber类型用户的消息，并将Customer类型用户的消息转换到分区1。</p>
<ul>
<li>在生产者属性中定义CustomPartitioner类，如下所示：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//将消息拆分到特定的分区</span><br><span class="line">props.put(&quot;partitioner.class&quot;, &quot;com.treselle.core.CustomPartitioner&quot;);</span><br></pre></td></tr></table></figure>
<ul>
<li>通过为消费者分配不同的分区来定义消费者主题的分区，如下所示：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val topicPartition = new TopicPartition(TOPIC,partition)</span><br><span class="line">consumer.assign(Collections.singletonList(topicPartition))</span><br></pre></td></tr></table></figure>
<ul>
<li>当同时有多个消费者，并且每个消费者接收不同的分区的消息时，将分区作为消费者的参数传入。</li>
<li>用不同的分区服务多个消费者。</li>
<li>使用以下命令启动Consumer1：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp custom_partitioner.jar com.treselle.core.ConsumerBasedOnPartition trip-data localhost:9092 0</span><br></pre></td></tr></table></figure>
<ul>
<li>使用以下命令启动Consumer2：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp custom_partitioner.jar com.treselle.core.ConsumerBasedOnPartition trip-data localhost:9092 1</span><br></pre></td></tr></table></figure>
<ul>
<li>使用以下命令定义自定义分区来生成行程的详细信息：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java –cp custom_partitioner.jar com.treselle.core.CustomPartionedProducer trip-data localhost:9092</span><br></pre></td></tr></table></figure>
<p>您可以仅查看消费者1来自分区0的Subscriber消息，仅查看消费者2来自分区1的Customer消息。</p>
<p>Consumer1：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/1ddjaqrdqf.jpeg" alt=""></p>
<p>Consumer2：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/ox93q540jk.jpeg" alt=""></p>
<ul>
<li>在两个消费者消费所有消息后，检查代理的内存。代理之间共享的内存以及代理的日志的内存可以在下图中查看：</li>
</ul>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/g9oyfh3t4b.png" alt=""></p>
<p>这里，Customer消息被代理localhost：9092消费，Subscriber消息被代理localhost：9093消费。由于Customer消息较少，因此其在kafka-logs（localhost：9092）中占用的内存就较少。</p>
<h2 id="创建行程数据流"><a href="#创建行程数据流" class="headerlink" title="创建行程数据流"></a>创建行程数据流</h2><p>在KSQL中，没有选择消费那些基于分区的消息。而从指定主题的所有分区中取出消息，用来创建流或表。要创建行程数据流，请执行以下步骤：</p>
<ul>
<li>使用窗口处理的条件分离Subscriber和Customer数据。</li>
<li>使用以下命令生成的行程数据来创建使用列来存放数据的trip_data_stream：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CREATE STREAM</span><br><span class="line">trip_data_stream</span><br><span class="line">(</span><br><span class="line">tripduration BIGINT,</span><br><span class="line">starttime VARCHAR,</span><br><span class="line">stoptime VARCHAR,</span><br><span class="line">start_station_id BIGINT,</span><br><span class="line">start_station_name VARCHAR,</span><br><span class="line">start_station_latitude DOUBLE,</span><br><span class="line">start_station_longitude DOUBLE,</span><br><span class="line">end_station_id BIGINT,</span><br><span class="line">end_station_name VARCHAR,</span><br><span class="line">end_station_latitude DOUBLE,</span><br><span class="line">end_station_longitude DOUBLE,</span><br><span class="line">bikeid INT,usertype VARCHAR,</span><br><span class="line">birth_year VARCHAR,</span><br><span class="line">gender VARCHAR</span><br><span class="line">)</span><br><span class="line">WITH</span><br><span class="line">(</span><br><span class="line">kafka_topic=&apos;trip-data&apos;,</span><br><span class="line">value_format=&apos;DELIMITED&apos;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用行程的开始时间提取Unix TIMESTAMP进行窗口化。</li>
<li>使用行程开始时间而不是消息生成时间来将提取的开始时间Unix TIMESTAMP设置为窗口流的属性。</li>
<li>为了使用以下命令查找订阅者的行程详细信息，所以使用提取的Unix TIMESTAMP和订阅者消息创建流，：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE STREAM</span><br><span class="line">subscribers_trip_data_stream</span><br><span class="line">WITH</span><br><span class="line">(</span><br><span class="line">TIMESTAMP=&apos;startime_timestamp&apos;,</span><br><span class="line">PARTITIONS=2</span><br><span class="line">) AS</span><br><span class="line">select</span><br><span class="line">STRINGTOTIMESTAMP(starttime, &apos;yyyy-MM-dd HH:mm:ss&apos;) AS startime_timestamp,</span><br><span class="line">tripduration,</span><br><span class="line">starttime,</span><br><span class="line">usertype</span><br><span class="line">FROM TRIP_DATA_STREAM</span><br><span class="line">where usertype=&apos;Subscriber&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="使用Window-Tumbling来执行流式分析"><a href="#使用Window-Tumbling来执行流式分析" class="headerlink" title="使用Window Tumbling来执行流式分析"></a>使用Window Tumbling来执行流式分析</h2><p>Window Tumbling将给定时间间隔内的数据分组到不重叠的大小固定的窗口中。它被用于在一定时间间隔内对流进行异常检测。例如下图，以5分钟的时间间隔进行翻滚分析。</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/8k54sp6bj4.png" alt=""></p>
<p>要以五分钟为间隔查找Subscribers开始的行程数，请执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">COUNT(*),</span><br><span class="line">starttime</span><br><span class="line">FROM subscribers_trip_data_stream</span><br><span class="line">WINDOW TUMBLING (SIZE 5 MINUTE)</span><br><span class="line">GROUP BY usertype;</span><br></pre></td></tr></table></figure>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/udh6pc3k3w.png" alt=""></p>
<p>从上述结果可以看出，第四分钟结束时已经开始了19次车程，第九分钟结束时开始了25次车程，第14分钟结束时开始了26次车程。因此，开始的行程在每个给定的时间间隔内计数。</p>
<h2 id="使用Window-Session执行流式分析"><a href="#使用Window-Session执行流式分析" class="headerlink" title="使用Window Session执行流式分析"></a>使用Window Session执行流式分析</h2><p>在Window session中，数据被分组在特定的会话中。例如，如果设置一个1分钟会话，并且在一分钟的时间间隔内数据是不可用的，则会开始一个新会话来分组数据。例如下图所示，分析一分钟的工作会话：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/x1s2m33fdo.png" alt=""></p>
<p>要将特定会话中用户的行程详细信息分组，请使用以下命令将会话间隔设置为20秒：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">count(*),</span><br><span class="line">starttime</span><br><span class="line">FROM subscribers_trip_data_stream</span><br><span class="line">WINDOW SESSION (20 SECOND)</span><br><span class="line">GROUP BY usertype;</span><br></pre></td></tr></table></figure>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/h410jrcpq3.png" alt=""></p>
<p>从上图可以看出，数据分组是在特定的间隔会话中进行的。当数据在20秒间隔内不可用时，会开始一个新会话来分组数据。</p>
<p>例如00:01:09到00:01:57之间的时间间隔。在00:01:09和00:01:33之间的时间间隔内，您可以查看20秒或更长的时间差的内容。所以，行程的数量增加。在00:01:33和00:01:57之间的间隔，您可以查看超过20秒的无活动间隔。所以，从第57秒开始新的会话。</p>
<h2 id="使用Window-Hopping执行流分析"><a href="#使用Window-Hopping执行流分析" class="headerlink" title="使用Window Hopping执行流分析"></a>使用Window Hopping执行流分析</h2><p>在Window Hopping中，通过前进给定的时间间隔，将数据按给定的时间间隔分组到重叠的窗口中。例如，如下图所示，分析以一分钟的前进间隔来工作的五分钟时间的行程信息：</p>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/bt7d5ygmfp.png" alt=""></p>
<p>要将一分钟前进间隔的五分钟时间的行程详细信息分组，请执行以下Hopping Window 分析命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">count(*),</span><br><span class="line">starttime</span><br><span class="line">FROM subscribers_trip_data_stream</span><br><span class="line">WINDOW HOPPING (SIZE 5 MINUTE, ADVANCE BY 1 MINUTE)</span><br><span class="line">GROUP BY usertype;</span><br></pre></td></tr></table></figure>
<p><img src="https://ask.qcloudimg.com/http-save/10009/3850/qfv05esfca.png" alt=""></p>
<p>从上面的图表可以看出，每个记录的五个条目在5分钟的时间内被消费并且使用的是一分钟的前进间隔。条目大小根据时间间隔大小和给定的前进间隔变化而变化。</p>
<p>在上面的例子中，考虑一个00:02:12的时间记录场景，用5分钟的时间检查跳频的工作情况，并给出一分钟大小的前进间隔。00:02:12场景有5个条目，其中旅行计数为7,7,7,6,1。在两分钟内，前三项只有两个1分钟的前进间隔。00:00:00至00:02:12的时间间隔内开始了七次行程。第四项前进一分钟。00:01:00至00:02:12时间间隔有六次行程，第五次进入另一个一分钟前进间隔。所以，从00:02:00到00:02:12被分析的行程只有一次。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.citibikenyc.com/system-data" target="_blank" rel="noopener">Citi Bike骑行样本数据</a></li>
<li><a href="https://howtoprogram.xyz/2016/06/04/write-apache-kafka-custom-partitioner" target="_blank" rel="noopener">Apache Kafka自定义分区程序</a></li>
<li><a href="https://github.com/confluentinc/ksql/blob/v0.3/docs/syntax-reference.md#syntax-reference" target="_blank" rel="noopener">KSQL的概念</a></li>
</ul>
<p><em>版权所有</em><br><em>想说这四个字很多年了，哈哈哈</em></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/英语/" rel="tag"><i class="fa fa-tag"></i> 英语</a>
          
            <a href="/tags/翻译/" rel="tag"><i class="fa fa-tag"></i> 翻译</a>
          
            <a href="/tags/技术/" rel="tag"><i class="fa fa-tag"></i> 技术</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/03/期中小结/" rel="next" title="期中小结">
                <i class="fa fa-chevron-left"></i> 期中小结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/28/明天，你好/" rel="prev" title="明天，你好">
                明天，你好 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">xujiang</p>
              <p class="site-description motion-element" itemprop="description">草末</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/sxyuanfeng" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                朋友
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wangtianzhi.me/" title="大智" target="_blank">大智</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#使用Kafka-SQL-Windowing进行自定义分区和分析"><span class="nav-number">1.</span> <span class="nav-text">使用Kafka SQL Windowing进行自定义分区和分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">1.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据描述"><span class="nav-number">1.2.</span> <span class="nav-text">数据描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用例"><span class="nav-number">1.3.</span> <span class="nav-text">用例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#概要"><span class="nav-number">1.4.</span> <span class="nav-text">概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置Kafka集群"><span class="nav-number">1.5.</span> <span class="nav-text">设置Kafka集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用自定义分区生成和使用行程详细信息"><span class="nav-number">1.6.</span> <span class="nav-text">使用自定义分区生成和使用行程详细信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建行程数据流"><span class="nav-number">1.7.</span> <span class="nav-text">创建行程数据流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Window-Tumbling来执行流式分析"><span class="nav-number">1.8.</span> <span class="nav-text">使用Window Tumbling来执行流式分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Window-Session执行流式分析"><span class="nav-number">1.9.</span> <span class="nav-text">使用Window Session执行流式分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Window-Hopping执行流分析"><span class="nav-number">1.10.</span> <span class="nav-text">使用Window Hopping执行流分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">1.11.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-telegram" aria-hidden="true"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xujiang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  
    <!-- 页面点击小红心 -->
	<script type="text/javascript" src="/js/src/love.js"></script>
	
</body>
</html>
